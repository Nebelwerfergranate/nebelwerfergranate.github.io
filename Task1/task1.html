<!DOCTYPE html>
<html lang="ru">
	<head>
		<meta charset="utf-8" />
		<title>Пузырьковая сортировка</title>
		
		<!-- подключаем mocha -->
	    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mocha/2.1.0/mocha.css">
	    <link rel="stylesheet" href="style.css">
	 	<script src="https://cdnjs.cloudflare.com/ajax/libs/mocha/2.1.0/mocha.js"></script>
		<script>
			mocha.setup('bdd'); // настраиваем Mocha на BDD-тестирование
	 	</script>
	
	  	<!-- подключаем chai -->
	  	<script src="https://cdnjs.cloudflare.com/ajax/libs/chai/3.5.0/chai.js"></script>
	  	<script>
	    	var assert = chai.assert; // выносим assert в глобальную область
	  	</script>
	  	
	  	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
	</head>
	<body>
		<div id="mod_window">
			<h2>Ошибка</h2>
			<p id="mod_text">Lorem ipsum dolor sit amet, consectetur adipisicing elit. Nam quasi possimus voluptatum magnam deleniti, laudantium, esse, autem tempore modi quo cumque. Harum fuga reiciendis quae earum nihil praesentium, magnam, dolores.</p>
		</div>
		
		<div class="container">
			<h1>Пузырьковая сортировка</h1>
			<div id="screen"></div>
			<div id="inputPanel">
				<h2>Создайте массив</h2>
				<input id="inputField" type="number" min="-999" max="999" step="1" value="0" required/>
				<button id="addNumberBtn" class="btn">Добавить число (enter)</button>
				<button id="startBtn" class="btn">Начать сортировку</button>
				<button id="randomBtn" class="btn">Для ленивых</button>
			</div>
			<div id="sortPanel" class="hidden">
				<h2>Выполнение сортировки</h2>
				<button id="nextStepBtn" class="btn">Следующий шаг (enter)</button>
				<button id="resetBtn" class="btn">Сброс</button>
				<button id="autoSortBtn" class="btn">Для ленивых</button>
			</div>
			
			<div id="comment">
				<h2>Обозначения:</h2>
				<p><span id="coment_one">1</span><span class="comment_text">Перестановка не требуется</span></p>
				<p><span id="comment_two">2</span><span class="comment_text">Перестановка выполнена</span></p>
				<p><span id="comment_tree">3</span><span class="comment_text">Уже отсортированные</span></p>
			</div>
			
			<!-- в элементе с id="mocha" будут результаты тестов -->
  			<div id="mocha"></div>
		</div>
		
		
		
		<!-- Скрипты -->
		<script type="text/javascript" src="sorter.js"></script>
		<script type="text/javascript" src="utils.js"></script>
		
		<script src="Test/StepByStepComparer.js"></script>
  		<script src="Test/test.js"></script>
  		<script>
  			mocha.run();
  		</script>
		
		<script>
			$().ready(function(){
	            var data = [];
	           	var sorter = null;
	           	
	           	var sortingIsRunning = false; // для работы обработчика нажатия клавиши enter.
	           	
	           	// для работы автоматической сортировки.
	           	var intervalId = null;
	           	var autosortIsRunning = false;
	           	
	           	var getRandomInt = Utils.getRandomInt;
	           	
	           	$("#inputField").select();
	           
	            $("#addNumberBtn").on("click", function() {
	            	var input = document.getElementById("inputField");
	            	var msg = $("#mod_text");
	            	
	            	if(!input.checkValidity()){
	            		if(input.validity.valueMissing){
	            			msg.text("Число не было введено");
	            		} else if(input.validity.rangeOverflow){
	            			msg.text("Число не должно быть более " + input.max);
	            		} else if(input.validity.rangeUnderflow){
	            			msg.text("Число не должно быть менее " + input.min);
	            		} else if(input.validity.stepMismatch){
	            			msg.text("Дробные числа не поддерживаются");
	            		} else {
	            			msg.text("Упс... что-то пошло не так :(");
	            		}
	            		
	            		$("#mod_window").fadeIn();
	            		closeModal();
	            		return;
	            	}
	            	
	               	data.push(parseInt(input.value));
	                input.value = 0;
	                input.select();
	                render(data);
	            })
	            
	            $(document).keydown(function(e) {
	            	if(e.keyCode == 13){
	            		e.preventDefault();
	            		if(sortingIsRunning){
	            			$("#nextStepBtn").click();
	            		}else{
	            			$("#addNumberBtn").click();	
	            		}
	            	}
				});
	            
	            $("#startBtn").on("click", function() {
	            	if(data.length < 2){
	            		return;
	            	}
	                $("#inputPanel").addClass("hidden");
	                $("#sortPanel").removeClass("hidden");
	                sortingIsRunning = true;
	                sorter = new Sorter(data);
	            });
	            
	            $("#randomBtn").on("click", function(){
	            	var capacity = 10;
			        for(var i = 0; i < capacity; i ++){
			            data.push(getRandomInt(-999, 999));
			        }
			        $("#startBtn").click();
			        render(data);
	            });
	            
	            
	            $("#nextStepBtn").on("click", function(){
	            	sorter.nextStep();
	            	
	            	render(sorter.data, sorter.numbersSorted);
		           	
		           	if(sorter.isSwapped){
		           		$("#screen p").eq(sorter.position).addClass("changed");
		            	$("#screen p").eq(sorter.position + 1).addClass("changed");
		           	} else{
		           		$("#screen p").eq(sorter.position).addClass("selected");
		            	$("#screen p").eq(sorter.position + 1).addClass("selected");	
		           	}
	            });
	            
	            $("#resetBtn").on("click", function(){
	            	sortingIsRunning = false;
	            	sorter = null;
	            	data = [];
	            	render(data);
	            	$("#inputPanel").removeClass("hidden");
	                $("#sortPanel").addClass("hidden");
	                autosortIsRunning = false;
	                clearInterval(intervalId);
	                $("#autoSortBtn").text("Для ленивых");
	            })
	            
	            $("#autoSortBtn").on("click", function(){
		            autosortIsRunning = !autosortIsRunning;
	            	
	            	if(autosortIsRunning){
	            		$("#autoSortBtn").text("Стоп");
	            		intervalId = setInterval(function(){
		            		if(sorter.numbersSorted < sorter.data.length){
		            			$("#nextStepBtn").click();
		            		}
		            		else{
		            			clearInterval(intervalId);
		            		}
		            	}, 500);	
	            	} else{
	            		clearInterval(intervalId);
	            		$("#autoSortBtn").text("Продолжить");
	            	}
	            });
	            
	            function render(data, numbersSorted){
	            	var numbersSorted = numbersSorted || 0;
	            	$("#screen").html("");
	            	for(var i = 0; i < data.length; i++){
		           		$("#screen").append( "<p>" + data[i] + "</p>" );
		           		if(data.length - i <= numbersSorted){
		           			$("#screen p").eq(i).addClass("sorted");	
		           		}
	            	}
	            }
	            
	            function closeModal(){
	            	setTimeout(function(){
	            		$("#mod_window").fadeOut();
	            		$("#mod_text").text("");
	            	}, 2000);
	            };
            });
		</script>
	</body>
</html>